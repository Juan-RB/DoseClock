{% extends 'medicamentos/base.html' %}

{% block title %}Historial - {{ tratamiento.nombre_medicamento }} - DoseClock{% endblock %}

{% block content %}
<div class="mb-4">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb mb-1">
      <li class="breadcrumb-item"><a href="{% url 'medicamentos:dashboard' %}">Inicio</a></li>
      <li class="breadcrumb-item"><a href="{% url 'medicamentos:tratamientos_list' %}">Tratamientos</a></li>
      <li class="breadcrumb-item"><a href="{% url 'medicamentos:tratamiento_detail' tratamiento.pk %}">{{ tratamiento.nombre_medicamento|truncatewords:2 }}</a></li>
      <li class="breadcrumb-item active" aria-current="page">Historial</li>
    </ol>
  </nav>
  <h1 class="h2">
    <i class="bi bi-clock-history me-2 text-primary"></i>
    Historial de Tomas
  </h1>
  <p class="text-muted">{{ tratamiento.nombre_medicamento }} - Cada {{ tratamiento.frecuencia_horas }}h</p>
</div>

<!-- Stats Summary -->
<div class="row g-3 mb-4">
  <div class="col-6 col-md-3">
    <div class="card text-center h-100">
      <div class="card-body">
        <div class="h2 mb-0 text-primary">{{ status_summary.total }}</div>
        <small class="text-muted">Total</small>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card text-center h-100">
      <div class="card-body">
        <div class="h2 mb-0 text-success">{{ status_summary.confirmed_on_time }}</div>
        <small class="text-muted">A tiempo</small>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card text-center h-100">
      <div class="card-body">
        <div class="h2 mb-0 text-warning">{{ status_summary.confirmed_late }}</div>
        <small class="text-muted">Tardias</small>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card text-center h-100">
      <div class="card-body">
        <div class="h2 mb-0 text-danger">{{ status_summary.missed }}</div>
        <small class="text-muted">No tomadas</small>
      </div>
    </div>
  </div>
</div>

<!-- Adherence Progress -->
<div class="card shadow-sm mb-4">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <span class="h6 mb-0">Tasa de Adherencia</span>
      <span class="h4 mb-0 text-primary">{{ status_summary.adherence_rate }}%</span>
    </div>
    <div class="progress" style="height: 20px;">
      <div class="progress-bar bg-success" style="width: {{ status_summary.adherence_rate }}%;">
        {{ status_summary.adherence_rate }}%
      </div>
    </div>
  </div>
</div>

<!-- Doses Table -->
<div class="card shadow-sm">
  <div class="card-header">
    <h2 class="h5 mb-0">Registro de Tomas</h2>
  </div>
  <div class="card-body p-0">
    {% if tomas %}
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>Fecha</th>
            <th>Hora Programada</th>
            <th>Estado</th>
            <th>Hora Confirmada</th>
            <th>Diferencia</th>
          </tr>
        </thead>
        <tbody>
          {% for toma in tomas %}
          <tr>
            <td>{{ toma.hora_programada|date:"d/m/Y" }}</td>
            <td>{{ toma.hora_programada|date:"H:i" }}</td>
            <td>
              <span class="badge" style="background-color: {{ toma.color_estado }};">
                {{ toma.get_estado_display }}
              </span>
            </td>
            <td>
              {% if toma.hora_confirmada %}
                {{ toma.hora_confirmada|date:"H:i" }}
              {% else %}
                <span class="text-muted">-</span>
              {% endif %}
            </td>
            <td>
              {% if toma.hora_confirmada %}
                {% if toma.estado == 'confirmada' %}
                  <span class="text-success"><i class="bi bi-check-circle me-1"></i>A tiempo</span>
                {% else %}
                  <span class="text-warning"><i class="bi bi-exclamation-circle me-1"></i>Tarde</span>
                {% endif %}
              {% elif toma.estado == 'no_tomada' %}
                <span class="text-danger"><i class="bi bi-x-circle me-1"></i>No tomada</span>
              {% else %}
                <span class="text-muted">Pendiente</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="text-center py-5 text-muted">
      <i class="bi bi-inbox display-4"></i>
      <p class="mt-2">No hay tomas registradas para este tratamiento</p>
    </div>
    {% endif %}
  </div>
</div>

<div class="mt-4">
  <a href="{% url 'medicamentos:tratamiento_detail' tratamiento.pk %}" class="btn btn-secondary">
    <i class="bi bi-arrow-left me-1"></i> Volver al tratamiento
  </a>
</div>
{% endblock %}
